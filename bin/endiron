#! /usr/bin/env python2
"""Script to replace environment keys in given directory"""

from __future__ import print_function
import os
import sys
import argparse
from bdb import BdbQuit


__version__ = '0.1.0'


class ScriptError(NotImplementedError):
    pass


def run_args(args, methods):
    """Run any methods eponymous with args"""
    if not args:
        return False
    valuable_args = {k for k, v in args.__dict__.items() if v}
    arg_methods = {methods[a] for a in valuable_args if a in methods}
    for method in arg_methods:
        method(args)


def version(args):
    print('%s %s' % (args, __version__))
    raise SystemExit


def Use_debugger(_args):
    try:
        import pudb as pdb
    except ImportError:
        import pdb
    pdb.set_trace()


def parse_args(methods):
    """Parse out command line arguments"""
    parser = argparse.ArgumentParser(description=__doc__.splitlines()[0])
    parser.add_argument('directory',
                        help='path to be abbreviated')
    parser.add_argument('-x', '--exclude', type=str, nargs='*',
                        help='exclude environment symbol')
    parser.add_argument('-v', '--version', action='store_true',
                        help='Show version')
    parser.add_argument('-U', '--Use_debugger', action='store_true',
                        help='Run the script with pdb (or pudb if available)')
    args = parser.parse_args()
    run_args(args, methods)
    return args


def matches(directory, exclude):
    result = {}
    for key, value in os.environ.items():
        if key in exclude:
            continue
        if not value:
            continue
        if value in directory:
            result[key] = value
    return result.items()


def replace(directory, exclude):
    result = []
    for key, value in matches(directory, exclude):
        replacement = '$' + key
        result.append(directory.replace(value, replacement))
    return result


def shortest(items):
    lengths = [(len(_), _) for _ in items]
    return sorted(lengths)[0][1]


def replace_home(directory):
    home = os.environ['HOME']
    if directory.startswith(home):
        return directory.replace(home, '~', 1)
    return directory


def script(args):
    replacements = replace(args.directory, args.exclude or [])
    try:
        print(replace_home(shortest(replacements)))
        return True
    except IndexError:
        print(replace_home(args.directory))
        return False


def main():
    """Run the script"""
    try:
        args = parse_args(globals())
        return os.EX_OK if script(args) else not os.EX_OK
    except BdbQuit:
        pass
    except SystemExit as e:
        return e.code
    except Exception, e:  # pylint: disable=broad-except
        if __version__[0] < '1':
            raise
        print(e, sys.stderr)
        return not os.EX_OK
    return os.EX_OK


if __name__ == '__main__':
    sys.exit(main())
