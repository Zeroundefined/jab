#! /bin/bash

# sst - run ssh from a terminal, and set titles to and fro

PATH_TO_SCRIPT=$(readlink -f $BASH_SOURCE)
PATH_TO_SCRIPTS=$(dirname $PATH_TO_SCRIPT)

source ~/.jab/jab_environ
source $JAB/functons

usage ()
{
	if [[ $# < 2 ]]
	then
		if [[ $# == 1 ]]
		then
			parts=$(echo $1 | tr '@' '\n' | wc -l)
			if [[ $parts -ne 2 ]]
			then
				echo "usage: $PATH_TO_SCRIPT <username> <server>" >&2
				exit 1
			fi
		fi
	fi
}

main ()
{
	parts=$(echo $1 | tr '@' '\n' | wc -l)
	if [[ $parts -eq 2 ]]
	then
		you=$(echo $1 | cut -d\@ -f 1)
		there_name=$(echo $1 | cut -d\@ -f 2)
		shift
	else
		local you=$1
		shift
		local there_name=$1
		shift
	fi
	local options=$*

	local here_name=$(python -c "import socket; print socket.getfqdn()")
	local here_ip=$(python $JAB/python/ifconfig.py 172)
	local there_ip=$(python -c "import socket; print socket.gethostbyname('$there_name')")
	if [[ $here_ip == $there_ip ]]
	then
		if [[ $you == $(whoami) ]]
		then
			echo "Here I am: $you@$there_name ($there_ip)" 2>&1
		else
			echo "Here is: $there_name ($there_ip)" >&2
			echo "	Perhaps you meant to use su?" >&2
		fi
		return
	fi
	local there_small=${there_name/.altobridge.com/}
	local me=$USER
	local here=`hostname -s`
	console_title_on ${you}@${there_small} && \
		ssh $options $you@$there_name && \
		console_title_off ${me}@${here}
}

usage $*
main $*

