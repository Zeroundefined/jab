#! /bin/bash

remove_checkout ()
{
	if [[ -n "$COPY_OF_CHECKOUT" && -f "$COPY_OF_CHECKOUT" ]]
	then rm -f "$COPY_OF_CHECKOUT"
	fi
}

svn_diff_file ()
{
	local direction=$1
	local path_to_file=$2
	local revision=
	if [[ -n $3 ]]
	then revision="$3"
	else
		if svn stat $path_to_file | grep -q "[AM]"
		then revision=$(svn info $path_to_file | grep 'Last Changed Rev' | cut -d: -f2 | tr -d ' ')
		else
			echo no change in $path_to_file
			exit
		fi
	fi

	local options="-O"
	[[ "$direction" == "horizontal" ]] && options="-o"

	COPY_OF_CHECKOUT=${path_to_file}.svn_checkout.r$revision

	svn cat -r $revision "$path_to_file" > "$COPY_OF_CHECKOUT"
	ls  -l "$path_to_file" "$COPY_OF_CHECKOUT"
	$VIM -d $options "$path_to_file" "$COPY_OF_CHECKOUT"
	remove_checkout
}

svn_diff_dir ()
{
	local direction=$1
	local path_to_directory=$2
	local revision=
	[[ -n $3 ]] && revision="$3"
	for modified in $(svn stat $path_to_directory | grep "^\s*M" | sed -e "s/M\s\+//")
	do
		svn_diff_file $direction $modified $revision
		if [[ -f svn.stop ]]
		then
			rm -f svn.stop
			break
		fi
	done
}

main ()
{
	VIM=vim
	ARGS=$*
	if [[ $ARGS =~ -g ]]
	then 
		VIM="gvim -f"
		ARGS=${ARGS/-g}
	fi
	if [[ -f $path ]]
	then
		svn_diff_file $ARGS
	else
		svn_diff_dir $ARGS
	fi
}

# set -x
trap remove_checkout EXIT
main $*
# set +x
