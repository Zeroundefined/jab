#! /bin/bash

atexit ()
{
	if [[ -n "$COPY_OF_CHECKOUT" && -f "$COPY_OF_CHECKOUT" ]]
	then rm -f "$COPY_OF_CHECKOUT"
	fi
}

main ()
{
	local direction=$1
	local path_to_file=$2
	local revision=
	if [[ -n $3 ]]
	then revision="$3"
	else
		if svn stat /home/abrogan/.jab/bin/svn_diff | grep -q "[AM]"
		then revision=$(svn info $path_to_file | grep 'Last Changed Rev' | cut -d: -f2 | tr -d ' ')
		else
			echo no change in $path_to_file
			exit
		fi
	fi

	local options="-O"
	[[ "$direction" == "horizontal" ]] && options="-o"

	COPY_OF_CHECKOUT=${path_to_file}.svn_checkout.r$revision

	svn cat -r $revision "$path_to_file" > "$COPY_OF_CHECKOUT"
	vim -d $options "$path_to_file" "$COPY_OF_CHECKOUT"
}

# set -x
trap atexit EXIT
main $*
# set +x
