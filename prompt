#! /bin/sh

export PROMPT_COLOUR=none
if [ "$1" == "green" ]
then
	export PROMPT_COLOUR="$PROMPT_GREEN"
	export PROMPT_OPPOSITE_COLOUR="$PROMPT_MAGENTA"
elif [ "$1" == "red" ]
then
	export PROMPT_COLOUR="$PROMPT_RED"
	export PROMPT_OPPOSITE_COLOUR="$PROMPT_CYAN"
elif [ "$1" == "blue" ]
then
	export PROMPT_COLOUR="$PROMPT_BLUE"
	export PROMPT_OPPOSITE_COLOUR="$PROMPT_YELLOW"
else
	export PROMPT_COLOUR=none
fi

show_svn_change ()
{
	stat_output=`svn stat 2>&1`
	if [[ $stat_output == "svn: warning: '.' is not a working copy" ]]
	then
		return 1
	else
		lines=`svn stat -q`
		if [[ -z $lines ]]
		then
			return 2
		else
			return 0
		fi
	fi
}

prompt_command ()
{
	if [ -z "$1" ]
	then
		how_do_you_do_nothing_in_a_bash_script=0
	elif [[ $1 == 0 ]]
	then
		export STATUS="${PROMPT_GREEN}$1${PROMPT_NO_COLOUR}"
	else
		export STATUS="${PROMPT_RED}$1${PROMPT_NO_COLOUR}"
	fi
	echo
	echo -ne $STATUS
	show_svn_change
	if [[ $? == 0 ]]
	then Dir="${PROMPT_OPPOSITE_COLOUR}\${PWD}${PROMPT_COLOUR}"
	else Dir="\$PWD"
	fi
	local python_version=$(python -c "import sys; print 'python%s.%s' % (sys.version_info[0], sys.version_info[1])")
	if [[ -n "$VIRTUAL_ENV" ]]
	then python_version=${python_version}.$(basename $VIRTUAL_NAME)
	fi
	export PS1=" ${PROMPT_COLOUR}[\D{%A %Y-%m-%d.%T} $python_version \u@\h:$Dir]${PROMPT_NO_COLOUR}\n$ "
	j --add "$(pwd -P)"
}

if [[ -n "$MYVIMRC" ]]
then
	export PS1="\$? [\u@\h:\$PWD]\n$ "
	export PROMPT_COMMAND='prompt_command $?'
elif [[ "$PROMPT_COLOUR" == "none" ]]
then
	unset PROMPT_COMMAND
	export PS1="\$? [\u@\h:\$PWD]\n$ "
else
	export PROMPT_COMMAND='prompt_command $?'
fi

bind '"\e[A"':history-search-backward
bind '"\e[B"':history-search-forward

