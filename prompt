#! /bin/bash


export PROMPT_COLOUR=none
if [ "$1" == "green" ]
then
	export PROMPT_COLOUR="$PROMPT_GREEN"
	export PROMPT_OPPOSITE_COLOUR="$PROMPT_MAGENTA"
elif [ "$1" == "red" ]
then
	export PROMPT_COLOUR="$PROMPT_RED"
	export PROMPT_OPPOSITE_COLOUR="$PROMPT_CYAN"
elif [ "$1" == "blue" ]
then
	export PROMPT_COLOUR="$PROMPT_BLUE"
	export PROMPT_OPPOSITE_COLOUR="$PROMPT_YELLOW"
else
	export PROMPT_COLOUR=none
fi

changes=0

get_svn_status ()
{
	if [[ -d ".svn" ]]
	then
		find . -type d -name .svn -prune -o -type d -print 2>/dev/null | while read dir 
		do
			if [ -d "$dir/.svn" ]
			then
				if svn stat -N "$dir" 2>/dev/null | grep -q ^[MAD]
				then
					export changes=1
					return 2
				fi  
			fi  
		done
	fi
}

prompt_command ()
{
	if [ -z "$1" ]
	then
		how_do_you_do_nothing_in_a_bash_script=0
	elif [[ $1 == 0 ]]
	then
		export STATUS="${PROMPT_GREEN}$1${PROMPT_NO_COLOUR}"
	else
		export STATUS="${PROMPT_RED}$1${PROMPT_NO_COLOUR}"
	fi
	echo
	echo -ne $STATUS
	changes=0
	[[ -n $IGNORE_CHANGES ]] || get_svn_status
	if [[ $? == 2 ]]
	then Dir="${PROMPT_OPPOSITE_COLOUR}\${PWD}${PROMPT_COLOUR}"
	else Dir="\$PWD"
	fi
	local python_version=$(python -c "import sys; print 'python%s.%s' % (sys.version_info[0], sys.version_info[1])")
	if [[ -n "$VIRTUAL_ENV" ]]
	then python_version=${python_version}.$(basename $VIRTUAL_NAME)
	fi
	console_whoami 2>/dev/null
	# local LEARNING=$(python -c "import random; a = random.randint(0,99); b = random.randint(0,99); print '%d * %d == %d' % ( a, b , a * b )")
	export PS1=" ${PROMPT_COLOUR}[\D{%A %Y-%m-%d.%T} $python_version \u@\h:$Dir]${PROMPT_NO_COLOUR}\n$ "
	python $(dirname $BASH_SOURCE)/bin/j.py --add "$(pwd -P)"
	history -a
}

if [[ -n "$MYVIMRC" ]]
then
	export PS1="\$? [\u@\h:\$PWD]\n$ "
	export PROMPT_COMMAND='prompt_command $?'
elif [[ "$PROMPT_COLOUR" == "none" ]]
then
	unset PROMPT_COMMAND
	export PS1="\$? [\u@\h:\$PWD]\n$ "
else
	export PROMPT_COMMAND='prompt_command $?'
fi
