#! /bin/bash

# Called functons because "functions" is ... something else

# sorted by strcmp of function name

# x

p ()
{
	local me=$USER
	local here=`hostname -s`
	export PYTHON=${PYTHON-python}
	console_title_on "python@${here}" && \
		$PYTHON $* && \
		console_title_off "${me}@${here}"
}

# xx

ag ()
{
	alias | grep $*
}


ai ()
{ 
    local sought="$*";
    ack --pyt "(import.*$sought|$sought import)"
}


cj ()
{
# commit jab
	svn ci $JAB -m"$*"
}

cl ()
{
	c $LOGS
}

cv ()
{
	kd $1
	fim `basename $1`
}

gg ()
{
	local readme="show grep results as vim commands"
	sought="$1"
	shift
	grep "$sought" $* | sed -e "s/^/vim /" -e "s|:.*| +/\"$sought\"|" | uniq
}

ky ()
{
	if [[ -z "$1" ]]
	then
		cd $PYTHON_HOME
	else
		kd $* > /dev/null
	fi
	y
}

ra ()
{
	run_as abrogan $*
}

rb ()
{
	run_as builder $*
}

ru ()
{
# do da root root route, do da ru !
	if [ -z "$*" ]
	then 
		SUDO
	else
		sudo $*
	fi
}

sk ()
{
	cp $1 ${1}.keep
	svn revert $1
	ls -l $1*
}

uj ()
{
# update $JAB from the repository
	if [[ `svn up $JAB | grep -v "At revision" | wc -l` != "0" ]]
	then
		BACK=`pwd`
		if [[ $BACK != "$HOME/.jab" ]]
		then
			cd $JAB
			. bashrc
			cd $BACK
		else
			. bashrc
		fi
	fi
}

ut ()
{
	if [[ -f $HOME/bin/upTrackers ]]
	then
		sh $HOME/bin/upTrackers
	elif [[ `hostname` == "ie-build-1" ]]
	then
		sudo su - builder -c "sh ~/bin/upTrackers"
	else
		ssh builder@ie-build-1 "sh ~/bin/upTrackers"
	fi
}

vd ()
{
	if ! diff -q "$1" "$2" >/dev/null
	then
		vim -do "$1" "$2"
	else
		echo "same"
	fi
}

vr ()
{
	if [[ -n $1 && -f $1 ]]
	then
		filename=$1
	elif [[ -f errors.err ]]
	then
		echo "filename = ./errors.err"
		filename=./errors.err
	elif [[ -f ~/errors.err ]]
	then
		echo "filename = ${HOME}/errors.err"
		filename=${HOME}/errors.err
	elif [[ -f /tmp/errors.err ]]
	then
		echo "filename = /tmp/errors.err"
		filename=/tmp/errors.err
	fi
	vim -c "call ReadTraceback(\"$filename\")"
}

zm ()
{
	du -cms $1 | sort -n | sed -e "s/      / M     /g"
}

# xxx

aiw ()
{ 
    local sought="$*";
    ack --pyt "(import.*\b$sought\b|\b$sought\b import)"
}


cff ()
{
	if [[ ! -d fred ]]
	then
		if [[ -e fred ]]
		then rm -f fred
		fi
		mkdir fred
	fi
	cd fred
}


cls ()
{
# clean, clear, ls
	rf quietly
	clear
	if [ -z "$*" ]
	then
	    ls -d `pwd`
	    echo
	fi
	ls $*
}

dev ()
{
	if [[ -d ~/dev ]]
	then
		echo ~/dev exists
		echo 
		here=$PWD
		cd ~/dev
		ls
		cd $here
		echo You may wish to try
		if [[ -d ~/src ]]
		then
			echo mv ~/dev/* ~/src
		else
			echo mv ~/dev ~/src
		fi
	fi
	[[ ! -d ~/src ]] && mkdir ~/src
	c ~/src $*
	ls
}

fsh ()
{
# run fred by his extension
	if [ -f fred.sh ]
	then
		sh fred.sh $*
	elif [ -f fred.py ]
	then
		p fred.py $*
	elif [ -f "fred.test" ]
	then
		try "fred.test" $*
	elif [ -f fred.c ]
	then
		/bin/rm -vf a.out
		gcc fred.c
		if [ -f a.out ]
		then
			./a.out
		fi
	else
		sh fred $*
	fi
}

fpy ()
{
# run fred.py if fred.sh exists
	if [ -f fred.py ]
	then
		p fred.py $*
	fi
}

. $JAB/bin/first_dir

jjj ()
{
# ssh back to the jab.ook (which is my laptop
# it goes by different hostnames, try in order of probablity
	local jjj_host=
	if ping -c 1 -t 1 jab.ook >/dev/null 2>&1
	then
		jjj_host=jab.ook
	elif ping -c 1 -t 1 dhcp92 >/dev/null 2>&1
	then
		jjj_host=dhcp92
	fi
	SSJ jab $jjj_host
}


llt ()
{
	first_dir $*
	l --color=always -lhtr "$dir" | less -R -m -N +G
}

lly ()
{
	first_dir $*
	reset=$(shopt -p dotglob)
	shopt -s dotglob
	ls -lhtr "$dir"/*.tests
	echo
	ls -lhtr "$dir"/*.test
	echo
	ls -lhtr "$dir"/*.py
	$reset
}

lyy ()
{
	reset=$(shopt -p dotglob)
	shopt -s dotglob
	ls -xd $(ls -F |grep \/$)
	echo
	ls -xhtr *.tests 2>/dev/null
	echo
	ls -xhtr *.test 2>/dev/null
	echo
	ls -xhtr *.py 2>/dev/null
	$reset
}

unalias try > /dev/null 2>&1
try ()
{
	TRY=$JAB/python/testing/try.py
	test -f ./try.py && TRY=./try.py
	python $TRY $*
}

SSJ ()
{
	SSH $* -i $JAB_KEY
}

SSH ()
{
	local you=$1
	shift
	local there_name=$1
	shift
	local options=$*

	local here_name=$(python -c "import socket; print socket.getfqdn()")
	local here_ip=$(python -c "import socket; print socket.gethostbyname('$here_name')")
	local there_ip=$(python -c "import socket; print socket.gethostbyname('$there_name')")
	if [[ $here_ip == $there_ip ]]
	then
		if [[ $you == $(whoami) ]]
		then
			echo "Here I am: $you@$there_name ($there_ip)" 2>&1
		else
			echo "Here is: $there_name ($there_ip)" >&2
			echo "	Perhaps you meant to use su?" >&2
		fi
		return
	fi
	local there_small=${there_name/.altobridge.com/}
	local me=$USER
	local here=`hostname -s`
	console_title_on "${you}@${there_small}" && \
		ssh $options $you@$there_name && \
		console_title_off "${me}@${here}"
}

vff ()
{
	FRED=
	found_fred=0
	test -f fred && FRED=fred
	if [[ -n $FRED ]]
	then
		found_fred=1
	fi
	found_wild=0
	for f in fred*[^~]
	do
		test -f $f && found_wild=1
	done
	if [[ $found_fred == 1 && $found_wild == 1 ]]
	then 
		v -p fred fred*[^~]
	elif [[ $found_wild == 1 ]]
	then 
		v -p fred*[^~] 
	else
		v fred
	fi
}

# xxxx

dark ()
{
	svn revert -q $JAB/vim/vimrc
}

down ()
{
	c ~/Download* $*
	ls -alhtr
}

stat ()
{
	if [[ -z "$1" ]]
	then
		clean quietly
		do_stat
	else
		for file in $*
		do 
			do_stat $file
		done
	fi
}

SUDO ()
{
	if [[ -n $1 ]]
	then
		user="-u $1"
		you_sir="$1"
	else
		user=
		you_sir=root
	fi
	me=$USER
	here=`hostname -s`
	console_title_on "${you_sir}@${here}" && \
		sudo -i $user && \
		console_title_off "${me}@${here}"
}

# xxxxx

build ()
{
	if [[ $USER == "jab" ]]
	then
		if [[ -n "$1" ]]
		then
			user=abrogan
		else
			user=builder
		fi
	else
		user=$USER
	fi
	if [[ -n "$1" && "$1" == "2" ]]
	then
		ssh $user@ie-build-2
	elif [[ "$HOSTNAME" == "ie-build-1" ]]
	then
		ssh $user@ie-build-2
	else
		ssh $user@ie-build-1
	fi
}

kodos ()
{
	pushd ~/bin/kodos-2.4.9/ >/dev/null
	/usr/bin/python kodos.py &
	popd >/dev/null
}

named ()
{
	dir=
	if first_dir $1
	then shift
	fi
	find $dir -name "$*"
}

track ()
{
	if [ -d ~/alans_tests ]
	then
		cd ~/alans_tests
		try
	else
		ssh abrogan@ie-track-1 $*
	fi
}

vfile ()
{
	`echo "$*" | sed -e"s/up to //" -e"s/^File/fim/" | sed -e"s/, line \([0-9]*\).*/ +\1/" -e"s/\.test +\([0-9]*\)/.py -c :tabnext|\1/"`
}

which ()
{ 
	( alias; declare -f ) | \
		$WHICH --tty-only --read-alias --read-functions --show-tilde --show-dot $@
}

# xxxxx

# xxxxxx

bright ()
{
	sed -i -e/color/d ~/.vimrc
}

revert ()
{
	if [[ -n "$1" ]]
	then
		cp $1 $1.changed
	fi
	svn revert $1
}

run_as ()
{
	username=$1
	shift
	if [[ -n "$1" ]]
	then 
		sudo -u $username $*
	else
		SUDO $username
	fi
}

# xxxxxxx

do_stat ()
{
	test -n "$1" && path=$1 || path="."
	if [[ -f $path || -d $path/.svn ]]
	then
		svn stat $path
	fi
}

statvim ()
{
	if [[ -z "$1" ]]
	then
		clean quietly
		do_stat | sed -e "s/^M/shd/" -e "s/^A/vim/" -e"s/^?/r/"
	else
		for file in $*
		do 
			do_stat $file | sed -e "s/^M/shd/" -e "s/^A/vim/"
		done
	fi | sort
}

svn_log ()
{
	if [ -n "$1" ]
	then
		if [[ -f $1 || -d $1 ]]
		then
			path=$1
			shift 
		fi
	else
		path="."
	fi
	local limit=${1-10}
	svn log -l $limit $path
}

svn_url ()
{
	test -n "$1" && dir=$1 || dir="."
	svn info $dir | grep URL
}

# xxxxxxxx

svn_diff () {
	dir=`/usr/bin/dirname $2`
	file=`basename $2`
	pushd "$dir" > /dev/null 2>&1
	if [[ "$1" == "vimdiff -o" ]]
	then 
		exe="$EDITOR -do"
	elif [[ "$1" == vimdiff ]]
	then 
		exe="$EDITOR -d"
	elif [[ -f $1 ]]
	then 
		exe="$1"
	elif [[ -f /usr/bin/$1 ]]
	then
		exe=/usr/bin/$1
	elif [[ -f ~/bin/$1 ]]
	then
		exe=~/bin/$1
	fi
	if diff -q "$file" .svn/text-base/"$file".svn-base
	then
		echo unchanged
	else
		$exe "$file" .svn/text-base/"$file".svn-base
	fi
	popd > /dev/null 2>&1
}

svn_info ()
{
	test -n "$1" && dir=$1 || dir="."
	svn info $dir 
}

# xxxxxxxxx

svn_issue ()
{
	svn log $* | grep -i "^issue" | head
}

# xxxxxxxxxx

to_source ()
{
	cd $SOURCE/$*
	clear
	ls
}

# xxxxxxxxxx

to_release ()
{
	cd $RELEASES/$*
	clear
	ls
}

# xxxxxxxxxxx

# xxxxxxxxxxxx

# xxxxxxxxxxxxx

# xxxxxxxxxxxxxx

# xxxxxxxxxxxxxxx

# xxxxxxxxxxxxxxxx

console_title_on ()
{
	if [[ -n $TERM_PROGRAM && $TERM_PROGRAM == "iTerm.app" ]]
	then
		echo -e "]1;$1"
	elif env | grep -iq konsole 2>/dev/null
	then
		dcop $KONSOLE_DCOP_SESSION renameSession $1
	else
		echo "Title: $1"
	fi
}

# xxxxxxxxxxxxxxxxx

console_title_off ()
{
	if [[ -n $TERM_PROGRAM && $TERM_PROGRAM == "iTerm.app" ]]
	then
		echo -e "]0;$1"
	elif env | grep -iq konsole 2>/dev/null
	then
		dcop $KONSOLE_DCOP_SESSION renameSession $1
	else
		echo "Title: $1"
	fi
}
		

