#! /bin/bash

. $JAB/bin/first_dir

# Called functons because "functions" is ... something else

# sorted by strcmp of function name

# x

c ()
{
    kd "$@"
    value=$?
    if [[ -f todo.txt ]]
    then
        todo_show
    fi
    return $value
}

f ()
{
    first_dir "$@" && shift
    local name=$1
    shift
    if [[ $name == "-name" ]]
    then
        echo "Do not use '-name'"
        name=$1
        shift
    fi
    find $dir -name "$name" -print "$@"
}

h()
{
    local lines=${1:-25}
    history | tail -n $lines
}

p ()
{
    local me=$USER
    local here=$(jostname)
    export PYTHON=${PYTHON-python}
    console_title_on "python@${here}" && \
        $PYTHON "$@" && \
        console_title_off "${me}@${here}"
}

v ()
{
    if [[ -z $* ]]
    then vim
    else
        if script=$(python2.7 $JAB_PYTHON/vim.py "$@")
        then bash $script
        fi
    fi
}

x ()
{
    /Users/jab/bin/exercise
}

y ()
{
    clear
    python $JAB_PYTHON/y.py "$@"
}

# xx

3d ()
{
    Tree -d "$@"
}

3y ()
{
    if [[ -f $1 ]]
    then
        dir=$(dirname $1)
        shift
    elif [[ -d $1 ]]
    then
        dir=$1
        shift
    else
        dir=
    fi
    Tree -P "*.py" $dir "$@"
}

IP ()
{
    for number in 172 192 100
    do
        if python $JAB_PYTHON/ifconfig.py $number
        then break
        fi
    done
}

cl ()
{
    if c "$@"
    then ls
    fi
}

cv ()
{
    kd $1
    v $(basename $1)
}

gf ()
{
    first_dir "$@" && shift
    name=$1
    shift
    find $dir -name "$name" -exec grep --colour "$@" -nH {} \;
}

fc ()
{
    first_dir "$@" && shift
    name=$1
    shift
    for path in $(find $dir -name $name -print)
    do
        echo cd $path
        if [[ -f $path ]]
        then builtin cd $(dirname $path)
        else builtin cd $path
        fi
    done
}

fd ()
{
    first_dir "$@" && shift
    name=$1
    shift
    find $dir -type d -name $name "$@"
}

ff ()
{
    first_dir "$@" && shift
    name=$1
    shift
    find $dir -name $name "$@"
}

fv ()
{
    first_dir "$@" && shift
    name=$1
    shift
    find $dir -name $name -exec vim {} \;
}

gg ()
{
    local readme="show grep results as vim commands"
    sought="$1"
    shift
    grep "$sought" "$@" | sed -e "s/^/vim /" -e "s|:.*| +/\"$sought\"|" | uniq
}

gp ()
{
    local __doc__="grep in python files under here, show results as vim commands"
    sought=$1
    shift
    seek=${sought//\\/\\\\}
    find . -name "*.py" -exec grep -l "$sought" {} \;  | sed -e "s:\(.*\):vim \1 +/\"$seek\":" | sort | uniq
}

gh ()
{
    local __doc__="show stuff from history"
    history | grep -v "\<\(history\|gh\)\>" | grep --color "$@"
}

gv ()
{
    if which gvim >/dev/null 2>&1
    then
        date >> ~/log/gvim.log
        echo gvim "$@" >> ~/log/gvim.log
        gvim "$@" 2>> ~/log/gvim.log
    else
        echo gvim not available >&2
        return 1
    fi
}

hd ()
{
    if [[ -n "$3" ]]
    then vim_diff "$1" "$2" "$3" -o
    else vim_diff "$1" "$2" -o
    fi
}

hv ()
{
    history | vim - +
}

ky ()
{
    first_dir "$@" && shift
    dir=${dir:-$PYTHON_HOME}
    kd $dir
    y "$@"
}

pi ()
{
    local me=$USER
    local here=$(jostname)
    local options=-noconfirm_exit
    if [[ $(ipython --help | grep no.*confirm) == "--no-confirm-exit" ]]
    then options=--no-confirm-exit 
    fi
    console_title_on "ipython@${here}" && \
        ipython $options "$@" && \
        console_title_off "${me}@${here}"
}

py ()
{
    if [[ -z "$@" ]]
    then
        python2.7
    else
        script=${1/%./.py}
        shift
        python2.7 $script "$@"
    fi
}

ra ()
{
    run_as abrogan "$@"
}

rf ()
{
    PYTHON_SCRIPT=$JAB_PYTHON/rf.py
    python $PYTHON_SCRIPT "$@"
}

rt ()
{
    $(python2.7 $JAB_PYTHON/remove_tarball.py "$@")
}

ru ()
{
# do da root root route, do da ru !
    if [ -z "$@" ]
    then
        SUDO
    else
        sudo "$@"
    fi
}

tm ()
{
    if [[ -z $1 ]]
    then SESSION=$(jostname)
    else
        SESSION=$1
        shift
    fi
    if ! tmux attach-session -t $SESSION "$@"
    then tmux new-session -s $SESSION "$@"
    fi
}

tf ()
{
    if [ $? -eq 0 ]
    then echo "true"
    else echo "false"
    fi
}

uj ()
{
# update $JAB from the repository
    if [[ $(svn up $JAB | grep -v "At revision" | wc -l) != "0" ]]
    then
        BACK=$(pwd)
        if [[ $BACK != "$JAB" ]]
        then
            cd $JAB
            . bashrc
            cd $BACK
        else
            . bashrc
        fi
    fi
}

v. ()
{
    v .
}

va ()
{
    _edit_jab aliases
}

vb ()
{
    _edit_jab bashrc
}

vd ()
{
    if [[ -n "$3" ]]
    then vim_diff "$1" "$2" "$3" -O
    else vim_diff "$1" "$2" -O
    fi
}

ve ()
{
    _edit_jab environ
}

vf ()
{
    _edit_jab functons
}

vh ()
{
    v ~/.bash_history +
}

vp ()
{
    _edit_jab prompt "$@"
}

vv ()
{
    v $JAB/vim/$1
}

zm ()
{
    du -cms $1 | sort -n | sed -e "s/      / M     /g"
}

# xxx

cff ()
{
    if [[ ! -d fred ]]
    then
        if [[ -e fred ]]
        then rm -f fred
        fi
        mkdir fred
    fi
    cd fred
}


clo ()
{
    c $(locate "$@")
}

cls ()
{
# clean, clear, ls
    rf -q
    clear
    if [ -z "$@" ]
    then
        ls -d $(pwd)
        echo
    fi
    ls "$@"
}

ddg ()
{
    firefox "https://next.duckduckgo.com/?q=$*"
}

dev ()
{
    if [[ -d ~/dev ]]
    then
        echo ~/dev exists
        echo
        here=$PWD
        cd ~/dev
        ls
        cd $here
        echo You may wish to try
        echo "    mv ~/dev/* ~/src; rm -rf ~/dev"
    fi
    [[ ! -d ~/src ]] && mkdir ~/src
    c ~/src "$@"
    ls
}

fgp ()
{
    fgv *.py "$@"
}

fgt ()
{
    fgv *.test *.tests "$@"
}

fsh ()
{
# run fred by his extension
    if [ -f fred.sh ]
    then
        bash fred.sh "$@"
    elif [ -f fred.py ]
    then
        p fred.py "$@"
    elif [ -f "fred.test" ]
    then
        try "fred.test" "$@"
    elif [ -f fred.c ]
    then
        /bin/rm -vf a.out
        gcc fred.c
        if [ -f a.out ]
        then
            ./a.out
        fi
    else
        bash fred "$@"
    fi
}

fpy ()
{
# run fred.py if fred.sh exists
    if [ -f fred.py ]
    then
        p fred.py "$@"
    fi
}

ght ()
{
    gh "$@" | tail
}

gv. ()
{
    PYTHONPATH=$(readlink -f .) gv .
}

gvd ()
{
    EDITOR=gvim vd "$@"
}

hub ()
{
    c $GITHUB_SOURCES "$@"
    ls
}

jjj ()
{
# ssh back to the jab.ook (which is my laptop
# it goes by different hostnames, try in order of probablity
    local jjj_host=
    if ping -c 1 -w 1 jab.ook >/dev/null 2>&1
    then
        jjj_host=jab.ook
    fi
    if [[ -z $jjj_host ]]
    then
        echo Could not ping jab.ook
    else
        ssj jab $jjj_host
    fi
}


jjy ()
{
    ky $JAB_PYTHON "$@"
}

jpm ()
{
    PYTHONPATH=$PYTHONPATH:$GITHUB_SOURCES/jpm python $GITHUB_SOURCES/jpm/bin/jpm "$@"
}

lly ()
{
    first_dir "$@" && shift
    reset=$(shopt -p dotglob)
    shopt -s dotglob
    ls -lhtr "$dir"/*.tests
    echo
    ls -lhtr "$dir"/*.test
    echo
    ls -lhtr "$dir"/*.py
    $reset
}

lrt ()
{
    first_dir "$@" && shift
    /bin/ls --color=always -lhtr "$dir" |  less -R -m -N +G
}

lyy ()
{
    reset=$(shopt -p dotglob)
    shopt -s dotglob
    ls -xd $(ls -F |grep \/$)
    echo
    ls -xhtr *.tests 2>/dev/null
    echo
    ls -xhtr *.test 2>/dev/null
    echo
    ls -xhtr *.py 2>/dev/null
    $reset
}

rff ()
{
    r fred
    r fred.*
}

rfq ()
{
    rq fred
    rq fred.*
}

rq. ()
{
    /bin/rm -rf ./*
}

rqa ()
{
    /bin/rm -rf ./* ./.* 2>&1 | grep -v 'cannot remove directory: `\./\.'
}

tmp ()
{
    c ~/tmp "$@"
}

unalias try > /dev/null 2>&1
try ()
{
    TRY=$JAB_PYTHON/testing/try.py
    test -f ./try.py && TRY=./try.py
    python $TRY "$@"
}

vib ()
{
    $EDITOR ~/.bashrc
    source_file ~/.bashrc
}

vla ()
{
    _edit_locals aliases
}

vle ()
{
    _edit_locals environ
}

vlf ()
{
    _edit_locals functons
}

vlo ()
{
    v $(locate "$@")
}

vff ()
{
    $($PYTHON $JAB_PYTHON/vff.py "$@")
}

vvb ()
{
    vvf sh.vim
}

vvf ()
{
    vv ftplugin/$1
}

vvg ()
{
    gv $JAB/vim/gvimrc
}

vvp ()
{
    vvf python
}

vvv ()
{
    vv vimrc
}

vvy ()
{
    vvf python/jab.vim
}

vtr ()
{
    python $JAB_PYTHON/vim_traceback.py "$@"
}

# xxxx

bump ()
{
    part=${1:-patch}
    bumpversion $part
    git push origin --tags
    grep current_version .bumpversion.cfg
}

down ()
{
    c ~/Download* "$@"
    ls -alhtr
}

mkcd ()
{
    local __doc__='make a directory and start using it';
    mkdir -p "$@" && cd "$@"
}

rq.. ()
{
    local directory_here=$(basename "$(pwd)")
    cd ..
    /bin/rm -rf "$directory_here"
}

SUDO ()
{
    if [[ -n $1 ]]
    then
        user="-u $1"
        you_sir="$1"
    else
        user=
        you_sir=root
    fi
    me=$USER
    here=$(jostname)
    console_title_on "${you_sir}@${here}" && \
        sudo -i $user && \
        console_title_off "${me}@${here}"
}

dicp ()
{
    COMMAND_FOR_SAME_FILES=cp
    _dixx "$1" "$2"
}

dihh ()
{
    COMMAND_FOR_SAME_FILES=hd
    _dixx "$@"
}

divv ()
{
    COMMAND_FOR_SAME_FILES=vd
    _dixx "$@"
}

this ()
{
    python -c "import this"
}

Tree ()
{
    tree "$@" | more
}

# xxxxx

build ()
{
    if [[ -f build.sh ]]
    then bash build.sh "$@"
    elif [[ -f Makefile ]]
    then make "$@"
    fi
}

clean ()
{
    rf -q "$@"
}

detab ()
{
    if [[ -f $1 ]]
    then
        if grep -Pq "^\s*\t\s*[^ \t]" $1
        then
            expand -i --tabs=4 $1 > /tmp/txt
            mv /tmp/txt $1
            echo detabbed
        else
            echo no tabs
        fi
    else
        echo not a file $1
    fi
}

range ()
{
    local python_script=$GITHUB_SOURCES/kd/kd.py
    value=1
    if ! destination=$(PYTHONPATH=$python_directory python $python_script "$@" 2>&1)
    then
        echo "$destination"
    else
        local real_destination=$(PYTHONPATH=$python_directory python -c "import os; print os.path.realpath('$destination')")
        if [[ $destination != $real_destination ]]
        then
            echo "ranger ($destination ->) $real_destination"
            destination=$real_destination
        elif [[ $destination != $1 && $1 != "-" ]]
        then
            echo "ranger $destination"
        fi
        ranger "$destination"
        value=0
    fi
    unset destination
    return $value
}

vfile ()
{
    echo "I should've used vtr"
    python2.7 $JAB_PYTHON/vfile.py "$@"
}

ylint ()
{
    python2.7 /home/alanb/.jab/src/python/site/ylint.py "$@"
}

# xxxxxx

please ()
{
    local last=$(history -p !-1)
    echo "sudo $last"
    sudo $last
}

run_as ()
{
    username=$1
    shift
    if [[ -n "$1" ]]
    then
        sudo -u $username "$@"
    else
        SUDO $username
    fi
}

# xxxxxxx

# xxxxxxxx

jostname ()
{
    echo ${HOSTNAME:-$(hostname -s)}
}

todo_edit ()
{
    local todo_txt="$JAB_TODO"
    local git_options="--git-dir=$JAB/.git --work-tree=$JAB"
    if [[ -f todo.txt ]]
    then
        todo_txt=todo.txt
        git_options=
    elif [[ -f TODO.md ]]
    then
        todo_txt=TODO.md
        git_options=
    fi
    v $todo_txt
    if git status -s $JAB_TODO 2>&1 | grep -q "M.*$(basename $JAB_TODO)"
    then
        git add $JAB_TODO
        git commit -m'more or less stuff to be done' $JAB_TODO
    elif svn stat "$JAB_TODO" 2>&1 | grep -q "M .* $JAB_TODO"
    then svn ci -m'more or less stuff to be done' "$JAB_TODO"
    fi
}

todo_show ()
{
    local todo_txt="$JAB_TODO"
    if [[ -f todo.txt ]]
    then todo_txt=todo.txt
    elif [[ -f TODO.md ]]
    then todo_txt=TODO.md
    fi
    python2.7 $JAB_PYTHON/todo.py $todo_txt
}

# xxxxxxxxxx

vim_diff ()
{
    one="$1"
    shift
    two="$1"
    shift
    options="$@"
    if ! diff -q "$one" "$two" >/dev/null
    then
        $EDITOR -d $options "$one" "$two"
    else
        echo same
    fi
}

# xxxxxxxxxx

# xxxxxxxxxxx

# xxxxxxxxxxxx

blank_script ()
{
    test -f $1 && return
    echo "#! /bin/bash" > $1
    echo "" >> $1
}

# xxxxxxxxxxxxx

# xxxxxxxxxxxxxx

console_whoami ()
{
    console_title_on $USER@$(jostname)...$(basename $PWD)
}

source_aliases ()
{
    local __doc__='source files which have aliases and remember the filenames'
    ALIASES="$ALIASES:$1"
    source $1
}

# xxxxxxxxxxxxxxx

# xxxxxxxxxxxxxxxx

console_title_on ()
{
    if [[ -n $TERM_PROGRAM && $TERM_PROGRAM == "iTerm.app" ]]
    then
        echo -e "\033]0;$1\007" # http://stackoverflow.com/a/6887306/500942
    elif env | grep -iq konsole 2>/dev/null
    then
        #dcop $KONSOLE_DCOP_SESSION renameSession $1
        echo -e "\033]0;$1\007" # http://stackoverflow.com/a/21380108/500942
    elif env | grep -iq gnome.terminal
    then
        echo -e "\033]0;$1\007" # http://askubuntu.com/a/22417/130752
    elif [[ -n $TERM ]]
    then
        if [[ $TERM == "linux" ]]
        then echo -e "]1;$1"
        elif [[ $TERM =~ "xterm" ]]
        then echo -ne "\033]0;$1\007" # http://askubuntu.com/a/22417/130752
        fi
    else
        echo "Title: $1"
    fi
}

# xxxxxxxxxxxxxxxxx

console_title_off ()
{
    if [[ -n $TERM_PROGRAM && $TERM_PROGRAM == "iTerm.app" ]]
    then
        echo -e "]0;$1"
    elif env | grep -iq konsole 2>/dev/null
    then
        dcop $KONSOLE_DCOP_SESSION renameSession $1
    elif env | grep -iq gnome.terminal
    then
        echo -e "\033]0;$1\007" # http://askubuntu.com/a/22417/130752
    elif [[ -n $TERM && $TERM == "linux" ]]
    then
        echo -e "]1;$1"
    elif [[ $TERM == "xterm" ]]
    then
        echo -e "\033]0;$1\007" # http://askubuntu.com/a/22417/130752
    else
        echo "Title: $1"
    fi
}

# _xxxxxxxxxxxxxxxxxxx
# functions starting with an underscore are intended for use within this file only

_dixx ()
{
    source_dir="$1"
    destination_dir="$2"
    local number_in_both=$(_divv_get_difference | grep Files | wc -l)
    if [[ $number_in_both -gt 0 ]]
    then
        echo
        echo "# Files 1 and 2 differ"
        _divv_get_difference | grep Files | sed -e "s/Files/$COMMAND_FOR_SAME_FILES/" -e "s/ and / /" -e "s/differ//"
    fi
    local number_in_source=$(_divv_get_difference | grep "Only in $source_dir" | wc -l)
    if [[ $number_in_source -gt 0 ]]
    then
        echo
        echo "Only in $source_dir"
        _divv_get_difference | grep "Only in $source_dir" | sed -e "s/Only in/vim /" -e "s|: |/|"
    fi
    local number_in_destination=$(_divv_get_difference | grep "Only in $destination_dir" | wc -l)
    if [[ $number_in_destination -gt 0 ]]
    then
        echo
        echo "Only in $destination_dir"
        _divv_get_difference | grep "Only in $destination_dir" | sed -e "s/Only in/vim /" -e "s|: |/|"
    fi
}

_edit_source ()
{
    local filepath=$1
    shift
    blank_script $filepath
    $EDITOR $filepath
    if echo $filepath | grep -q alias
    then
        source_aliases $filepath
    else
        source_file $filepath "$@"
    fi
}

_edit_jab ()
{
    if [[ -z $JAB ]]
    then
        echo \$JAB is empty >&2
    else
        test -d $JAB || mkdir -p $JAB
        local filepath=$JAB/$1
        shift
        _edit_source $filepath "$@"
    fi
}

_edit_locals ()
{
    local local_dir=$JAB/local
    test -d $local_dir || mkdir -p $local_dir
    _edit_source $local_dir/$1
}

_divv_get_difference ()
{
    local source_gitignore=
    test -f "$source_dir/.gitignore" && source_gitignore="--exclude-from=$source_dir/.gitignore"
    local destination_gitignore=
    test -f "$destination_dir/.gitignore" && destination_gitignore="--exclude-from=$destination_dir/.gitignore"
    diff -q -r \
        --exclude=.svn \
        --exclude=.git \
        --exclude=.DS_Store \
        --exclude="*.fail" \
        --exclude="*.py[co]" \
        --exclude=tags \
        --exclude=".*sw[po]" \
        --exclude=tmp \
        --exclude="*~" \
        --exclude="*.beam" \
        --exclude="*.a" \
        --exclude="*.o" \
        --exclude=.gitignore \
        $source_gitignore \
        $destination_gitignore \
    "$source_dir" "$destination_dir" 2>/dev/null
}

